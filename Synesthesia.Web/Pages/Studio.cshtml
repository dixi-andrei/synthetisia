@page
@model Synesthesia.Web.Pages.StudioModel
@{
    ViewData["Title"] = "Fractal Studio";
}

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
    }

    #studio-stage {
        position: relative;
        width: 100vw;
        height: calc(100vh - var(--header-height));
        overflow: hidden;
    }

    #fractal-container {
        width: 100%;
        height: 100%;
        background: #000;
        overflow: hidden;
    }

    main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .btn-syn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.4);
        color: white;
        padding: 4px;
        border-radius: 80px;
        transition: 0.3s;
        font-size: 1.1rem;
        text-decoration: none;
    }

    .btn-syn:hover {
        background: rgba(255,255,255,0.4);
        color: #16003B;
        text-decoration: none;
    }

    .btn-syn-success {
        background: rgba(0, 255, 120, 0.25);
        border: 2px solid rgba(0, 255, 120, 0.5);
        color: #eaffea;
        padding: 4px;
        border-radius: 80px;
        transition: 0.3s;
        font-size: 1.1rem;
    }

    .btn-syn-success:hover {
        background: rgba(0, 255, 120, 0.45);
        color: #102b12;
    }

    .btn-syn:disabled,
    .btn-syn-success:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: rgba(255,255,255,0.2);
        color: rgba(255,255,255,0.7);
        border-color: rgba(255,255,255,0.4);
    }

    .btn-syn:disabled:hover,
    .btn-syn-success:disabled:hover {
        background: rgba(255,255,255,0.2);
        color: rgba(255,255,255,0.7);
    }

    a {
        color: #ffe;
    }

    a:hover {
        color: #88e5fc;
    }

    .form-floating > label {
        color: lightslategray !important;
    }

    .custom-file-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
        cursor: pointer;
    }

    .custom-file-input {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        pointer-events: none;
    }

    .custom-file-label {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.4);
        color: white;
        padding: 8px;
        border-radius: 80px;
        transition: 0.3s;
        font-size: 1.1rem;
        display: inline-block;
        cursor: pointer;
        text-align: center;
        width: 100%;
    }

    .custom-file-label:hover {
        background: rgba(255,255,255,0.4);
        color: #16003B;
    }

    .syn-label {
        color: #e0e0ff;
        font-weight: 500;
        margin-bottom: 8px;
        display: block;
    }

    .alert {
        border-radius: 20px;
        padding: 12px 20px;
        margin-bottom: 15px;
        backdrop-filter: blur(10px);
    }

    .alert-success {
        background: rgba(0, 255, 120, 0.2);
        border: 2px solid rgba(0, 255, 120, 0.4);
        color: #eaffea;
    }

    .alert-danger {
        background: rgba(255, 50, 50, 0.2);
        border: 2px solid rgba(255, 50, 50, 0.4);
        color: #ffeeee;
    }

    .rounded-audio {
        border-radius: 80px;
        overflow: hidden;
    }



   /*  #studio-stage {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
    } */

    /* #fractal-container {
        position: absolute;
        inset: 0;
        background: black;
    } */

    #fractal-settings {
        position: absolute;
        top: 50%;
        right: 0;
        transform: translateY(-50%) translateX(0);
        width: 300px;
        height: calc(100vh - var(--header-height) - 5vh);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: rgba(15, 10, 35, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 18px 0 0 18px;
        backdrop-filter: blur(14px);
        transition: transform 0.3s ease;
        overflow-y: auto;
    }

    #fractal-settings input[type="color"],
    #fractal-settings input[type="range"],
    #fractal-settings select,
    #fractal-settings label {
        flex-shrink: 0;
    }

    #fractal-settings.closed {
        transform: translateY(-50%) translateX(300px);
    }

    .menu-toggle {
        position: absolute;
        top: 10%;
        right: 300px;
        transform: translateY(-50%);
        width: 30px;
        height: 100px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.3);
        background: rgba(30, 30, 60, 0.7);
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        transition: right 0.3s ease, transform 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 4px;
    }

    .menu-toggle.closed {
        right: 0;
        transform: translateY(-50%) rotate(180deg);
    }

    #fractal-settings .syn-label {
        font-size: 0.85rem;
        margin-bottom: 2px;
    }

    #fractal-settings input[type="range"],
    #fractal-settings input[type="color"],
    #fractal-settings select {
        width: 100%;
    }

    #fractal-settings input[type="range"] {
        height: 4px;
    }

    #fractal-settings select {
        background: rgba(255,255,255,0.15);
        color: white;
        border: 1px solid rgba(255,255,255,0.25);
        border-radius: 10px;
        padding: 6px;
    }

    #fractal-settings::-webkit-scrollbar {
        width: 0;
    }

    #fractal-settings select {
        background: rgba(15,10,35,0.95);
        color: #e0e0ff;
        border: 1px solid rgba(255,255,255,0.25);
        border-radius: 10px;
        padding: 6px;
    }

    #fractal-settings select option {
        color: #e0e0ff;
        background: rgba(15,10,35,0.95);
    }

    #fractal-settings input[type="color"] {
        -webkit-appearance: none;
        border: 0.5px solid rgba(255,255,255,0.25);
        border-radius: 6px;
        padding: 0;
        width: 100%;
        height: 28px;
        cursor: pointer;
    }

    .settings-divider {
        height: 1px;
        background: linear-gradient( to right, transparent, rgba(255,255,255,0.25), transparent );
        margin: 8px 0;
    }

    .settings-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
        border-radius: 15px;
    }

    .settings-info details {
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 12px;
        padding: 6px 8px;
    }

    .settings-info summary {
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        color: #e0e0ff;
        list-style: none;
    }

    .settings-info summary::-webkit-details-marker {
        display: none;
    }

    .settings-info .details-body {
        margin-top: 6px;
        font-size: 0.75rem;
        line-height: 1.4;
        color: #cfd3ff;
    }

    .settings-info pre {
        background: rgba(0,0,0,0.35);
        border-radius: 8px;
        padding: 6px;
        font-size: 0.7rem;
        overflow-x: auto;
    }

    .settings-audio {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .settings-audio audio {
        width: 100%;
        height: auto;
        border-radius: 12px;
        -webkit-appearance: menulist-button;
    }

    #audio-upload-bar {
        position: absolute;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20;
        display: flex;
        gap: 6px;
        align-items: center;
    }

    #audio-upload-bar .btn-syn {
        padding: 4px 10px;
        font-size: 0.85rem;
        border-radius: 80px;
    }

    #audio-upload-bar .custom-file-wrapper {
        width: auto;
    }

    #julia-settings,
    #mandelbrot-settings,
    #mandelbulb-settings {
        display: none;
        flex-direction: column;
        gap: 6px;
    }
</style>

<div style="padding-bottom:0"> @* overwrite bottom padding from default setting set in site.css for synesthesia-gradient-top-left *@
    @* <img src="~/images/studio_title_slim.png" alt="Experiment with Fractals Title" style="width: 425px; height: auto;" /> *@

    @* <form method="post" enctype="multipart/form-data" asp-page-handler="Upload" class="mb-3 mt-3">
        <div style="display: flex; gap: 10px; width: 40vw;">
            <div class="custom-file-wrapper" style="flex: 1;">
                <label class="custom-file-label" id="fileLabel" for="audioInput">Choose Audio File</label>
                <input id="audioInput" type="file" name="audioFile" accept=".mp3,.wav" class="custom-file-input" required>
            </div>

            <button id="uploadBtn" class="btn-syn" type="submit" style="flex: 1;" disabled>
                Upload
            </button>
        </div>
    </form> *@

    <div id="studio-stage">
        <div id="fractal-container" style="width:100vw; height:100vh; background:#000; overflow:hidden;"></div>

        <form method="post"
              enctype="multipart/form-data"
              asp-page-handler="Upload"
              id="audio-upload-bar">

            <div class="custom-file-wrapper">
                <label class="btn-syn" id="fileLabel" for="audioInput">
                    Choose Audio
                </label>

                <input id="audioInput"
                       type="file"
                       name="audioFile"
                       accept=".mp3,.wav"
                       class="custom-file-input"
                       required />
            </div>

            <button id="uploadBtn"
                    class="btn-syn"
                    type="submit"
                    disabled>
                Upload
            </button>
        </form>

        <div id="fractal-settings">
            <div class="settings-audio">
                <div id="audio-container" style="display: flex; flex-direction: column; gap: 6px;">
                    <span id="audio-placeholder"
                          style="color: #ccc; text-align: center; @(string.IsNullOrEmpty(Model.AudioPath) ? "" : "display:none;")">
                        UPLOAD AN AUDIO FILE FIRST
                    </span>

                    <audio id="audio"
                           controls
                           crossorigin="anonymous"
                           class="rounded-audio"
                           src="@(Model.AudioPath ?? "")"
                           style="@(string.IsNullOrEmpty(Model.AudioPath) ? "display:none;" : "display:block;")">
                    </audio>

                    <button id="saveVideoBtn"
                            type="button"
                            class="btn-syn"
                            style="width:100%; font-size:0.85rem; display:none; margin-top:6px;"
                            disabled>
                        Save Video
                    </button>

                </div>

                <select id="fractalType" style="border-radius: 15px; padding: 6px 10px; margin-top: 6px;">
                    <option value="julia" selected>Julia 2D</option>
                    <option value="mandelbrot">Mandelbrot 2D</option>
                    <option value="mandelbulb">Mandelbulb 3D</option>
                </select>

                <div id="save-actions" style="margin-top:6px; display:none;">
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <form id="saveForm" method="post" asp-page-handler="SaveToProfile" style="margin-top:6px; display:none;">
                            <input type="hidden" id="audioPathInput" name="audioPath" value="" />
                            <input type="hidden" id="originalFileNameInput" name="originalFileName" value="" />

                            <input type="hidden" id="settingsJsonInput" name="settingsJson" value="" />
                            <input type="hidden" id="fractalTypeInput" name="fractalType" value="" />


                            <button id="saveBtn" type="submit" class="btn-syn-success" style="width:100%; font-size: 0.85rem;">
                                Save to Profile
                            </button>
                        </form>
                    }

                    @if (User.Identity?.IsAuthenticated != true)
                    {
                        <a id="loginToSaveLink"
                           class="btn-syn"
                           asp-area="Identity"
                           asp-page="/Account/Login"
                           style="display:block; text-align:center; font-size: 0.85rem;">
                            Login to Save
                        </a>
                    }
                </div>

                <div class="settings-divider"></div>
            </div>

            <div id="julia-settings">
                <label class="syn-label">Iterations</label>
                <input type="range" min="50" max="800" value="300" id="iterSlider">

                <label class="syn-label">Bass Strength</label>
                <input type="range" min="0" max="5" step="0.1" value="1" id="bassSlider">

                <label class="syn-label">Treble Strength</label>
                <input type="range" min="0" max="5" step="0.1" value="1" id="trebleSlider">

                <label class="syn-label">Primary Color</label>
                <input type="color" id="primaryColor" value="#291E7D">

                <label class="syn-label">Secondary Color</label>
                <input type="color" id="secondaryColor" value="#872D53">

                <label class="syn-label">
                    <input type="checkbox" id="rainbowToggle">
                    Rainbow mode
                </label>

                <label class="syn-label">Julia Set</label>
                <select id="juliaPreset"
                        onchange="updateFractalConfig({ julia: juliaPresets[this.value] })"
                        style="border-radius: 15px;">

          
                    <option value="classic">−0.4 − 0.59i</option>
                    <option value="dragon">0.37 + 0.1i</option>
                    <option value="snowflake">0.355 + 0.355i</option>
                    <option value="spiral">0.34 − 0.05i</option>
                    <option value="lotus">−0.54 + 0.54i</option>
                    <option value="chaos">0 + 0.8i</option>
                </select>
            </div>

            <div id="mandelbrot-settings">
                <label class="syn-label">Iterations</label>
                <input type="range" min="10" max="350" step="1" value="150" id="mandelIterSlider">

                <label class="syn-label">Bass Strength</label>
                <input type="range" min="0" max="1.2" step="0.05" value="0.6" id="mandelBassSlider">

                @* <label class="syn-label">Treble Strength</label>
                <input type="range" min="0" max="4" step="0.1" value="1" id="mandelTrebleSlider"> *@

                <label class="syn-label">Primary Color</label>
                <input type="color" id="mandelPrimaryColor" value="#291E7D">

                <label class="syn-label">Secondary Color</label>
                <input type="color" id="mandelSecondaryColor" value="#872D53">

                <label class="syn-label">
                    <input type="checkbox" id="mandelRainbowToggle">
                    Rainbow mode
                </label>
            </div>

            <div id="mandelbulb-settings">
                <label class="syn-label">Ray Steps</label>
                <input type="range" min="30" max="200" step="1" value="100" id="bulbRayStepsSlider">

                <label class="syn-label">Bass Strength</label>
                <input type="range" min="0" max="5" step="0.1" value="1" id="bulbBassSlider">

                <label class="syn-label">Treble Strength</label>
                <input type="range" min="0" max="5" step="0.1" value="1" id="bulbTrebleSlider">

                <label class="syn-label">Rotation Speed</label>
                <input type="range" min="0" max="2" step="0.01" value="0.2" id="bulbRotSlider">

                <label class="syn-label">Zoom Pulse</label>
                <input type="range" min="0" max="0.4" step="0.01" value="0.05" id="bulbZoomPulseSlider">

                <label class="syn-label">Primary Color</label>
                <input type="color" id="bulbPrimaryColor" value="#291E7D">

                <label class="syn-label">Secondary Color</label>
                <input type="color" id="bulbSecondaryColor" value="#872D53">

                <label class="syn-label">
                    <input type="checkbox" id="bulbRainbowToggle">
                    Rainbow mode
                </label>
            </div>


            <div class="settings-info">
                <div class="settings-divider"></div>

                <details data-fractal="mandelbrot">
                    <summary>Mandelbrot Info</summary>
                    <div class="details-body">
                        <p><strong>About Mandelbrot Sets:</strong></p>
                        <p>The Mandelbrot set is a famous 2D fractal defined by iterating the formula <code>zₙ₊₁ = zₙ² + c</code> for each pixel, where <code>z₀ = 0</code> and <code>c</code> represents the complex coordinate of that pixel. Points that remain bounded after many iterations are part of the set; others escape to infinity. The resulting shape exhibits intricate, self-similar patterns at all scales.</p>

                        <p><strong>Parameters:</strong></p>
                        <ul>
                            <li><strong>Iterations:</strong> Number of iterations applied per pixel. Higher values reveal more detail and sharper edges. In this visualizer, the number of iterations decreases dynamically with the <em>bass level</em>, making the fractal appear more "blobby" when bass hits strongly.</li>
                            <li><strong>Bass Strength:</strong> Determines how strongly the fractal responds to low-frequency audio. Higher bass levels reduce iterations and create a pulsating, softening effect on the fractal’s boundaries.</li>
                            <li><strong>Primary & Secondary Colors:</strong> Define the main color palette for the fractal when rainbow mode is disabled.</li>
                            <li><strong>Rainbow Mode:</strong> When enabled, colors continuously cycle across the spectrum, and the fractal's brightness subtly reacts to bass.</li>
                        </ul>
                    </div>
                </details>

                <details data-fractal="julia">
                    <summary>Julia Info</summary>
                    <div class="details-body">
                        <p><strong>About Julia Sets:</strong></p>
                        <p>Julia sets are 2D fractals derived from the Mandelbrot set. Each Julia set is generated by fixing a complex constant <code>c</code> and iterating the formula <code>zₙ₊₁ = zₙ² + c</code> for every pixel. While the Mandelbrot set varies <code>c</code> per pixel, a Julia set keeps <code>c</code> constant, producing unique patterns.</p>

                        <p><strong>Parameters:</strong></p>
                        <ul>
                            <li><strong>Iterations:</strong> Number of times the formula is applied per pixel. Higher values reveal more detail and sharper fractal boundaries.</li>
                            <li><strong>Bass Strength:</strong> Makes the fractal move and pulse with low notes in the music.</li>
                            <li><strong>Treble Strength:</strong> Makes the fractal shimmer and change colors with high notes in the music.</li>
                            <li><strong>Primary & Secondary Colors:</strong> Define the main color palette of the fractal, only for when rainbow mode is deactivated.</li>
                            <li><strong>Rainbow Mode:</strong> When enabled, colors continuously cycle across the spectrum, enhanced by treble and bass audio levels.</li>
                        </ul>
                    </div>
                </details>

                <details data-fractal="mandelbulb">
                    <summary>Mandelbulb Info</summary>
                    <div class="details-body">
                        <p><strong>About Mandelbulbs:</strong></p>
                        <p>
                            The Mandelbulb is a famous <strong>3D fractal</strong> - often described as a “Mandelbrot set in 3D”.
                            Instead of iterating a complex number in 2D, the Mandelbulb iterates a point in 3D space
                            using a spherical-coordinate power formula. The result is a volumetric shape with
                            intricate cavities, ridges, and self-similar detail when you zoom in.
                        </p>

                        <p>
                            In this studio, the Mandelbulb is rendered using <strong>distance estimation</strong> and
                            <strong>ray marching</strong>. For each pixel, a ray is shot into the scene from the camera.
                            The renderer repeatedly steps forward by an estimated “safe distance” to the surface
                            until it either hits the fractal (a surface threshold) or gives up after too many steps.
                            When a hit occurs, the surface normal is approximated from the distance field and lit
                            with a directional light to reveal depth and form.
                        </p>

                        <p><strong>Parameters:</strong></p>
                        <ul>
                            <li>
                                <strong>Ray Steps:</strong> Controls how many ray-march steps are allowed per pixel.
                                Higher values produce cleaner edges, deeper cavities, and more visible detail, but cost more performance.
                                Lower values render faster but can look “hollow”, noisy, or miss thin features.
                            </li>

                            <li>
                                <strong>Bass Strength:</strong> Amplifies how strongly the fractal responds to low-frequency energy.
                                In this Mandelbulb, bass influences the fractal’s internal dynamics (like the exponent/power and overall motion feel),
                                so stronger bass typically makes the bulb feel more “alive” — swelling, thickening, or changing character on heavy hits.
                            </li>

                            <li>
                                <strong>Treble Strength:</strong> Amplifies the response to high-frequency energy.
                                Treble tends to add sharper, faster variation to the fractal’s look over time, often perceived as extra shimmer,
                                flicker, or “sparkle” in the surface lighting and fine structure.
                            </li>

                            <li>
                                <strong>Rotation Speed:</strong> Controls how quickly the camera/fractal rotates over time.
                                A low value creates a slow cinematic spin that shows structure gradually; higher values create a more energetic,
                                constantly changing view that can feel more reactive to music.
                            </li>

                            <li>
                                <strong>Zoom Pulse:</strong> Adds a subtle zoom “breathing” effect that is driven by bass.
                                A small pulse gives gentle depth movement; higher values create stronger push-pull motion that can feel like the bulb
                                is pulsing toward and away from the viewer.
                            </li>

                            <li>
                                <strong>Primary &amp; Secondary Colors:</strong> Define the core palette for the Mandelbulb.
                                The renderer blends these colors based on lighting and depth, so surfaces facing the light and closer regions can shift
                                toward one color while shadowed or deeper areas shift toward the other.
                            </li>

                            <li>
                                <strong>Rainbow Mode:</strong> When enabled, the palette is mixed with a time-varying rainbow ramp.
                                This produces a spectrum-cycling look while still keeping your palette as an “anchor”, so it remains visually consistent
                                with your chosen style.
                            </li>
                        </ul>
                    </div>
                </details>

            </div>
        </div>

        <button id="menuToggle" class="menu-toggle">
            &#10095;
        </button>
    </div>
</div>

@section Scripts {
    <script src="~/lib/three/three.min.js"></script>
    <script src="~/js/fractal-studio.js"></script>

    <script>
        const fileInput = document.getElementById('audioInput');
        const fileLabel = document.getElementById('fileLabel');
        const uploadBtn = document.getElementById('uploadBtn');

        uploadBtn.disabled = true;
        uploadBtn.style.opacity = 0.5;

        fileInput.addEventListener('change', (e) => {
            const fileName = e.target.files[0]?.name || "Choose Audio File";
            fileLabel.textContent = fileName;

            if (fileName !== "Choose Audio File") {
                uploadBtn.disabled = false;
                uploadBtn.style.opacity = 1;
            } else {
                uploadBtn.disabled = true;
                uploadBtn.style.opacity = 0.5;
            }
        });
    </script>

    <script>
        const fractalTypeSelect = document.getElementById('fractalType');
        const infoBlocks = document.querySelectorAll('.settings-info details');

        const juliaSettings = document.getElementById('julia-settings');
        const mandelbrotSettings = document.getElementById('mandelbrot-settings');
        const mandelbulbSettings = document.getElementById('mandelbulb-settings');

        function updateInfoVisibility() {
          infoBlocks.forEach(d => {
            d.style.display = (d.dataset.fractal === fractalTypeSelect.value) ? 'block' : 'none';
            d.removeAttribute('open');
          });
        }

        window.updateFractalSettingsVisibility = function () {
          const type = fractalTypeSelect.value;
          juliaSettings.style.display = type === 'julia' ? 'flex' : 'none';
          mandelbrotSettings.style.display = type === 'mandelbrot' ? 'flex' : 'none';
          mandelbulbSettings.style.display = type === 'mandelbulb' ? 'flex' : 'none';
        };

        window.updateInfoVisibility = updateInfoVisibility;

        window.addEventListener('DOMContentLoaded', () => {
          updateInfoVisibility();
          window.updateFractalSettingsVisibility();
        });

        fractalTypeSelect.addEventListener('change', () => {
          updateInfoVisibility();
          window.updateFractalSettingsVisibility();
        });
    </script>

    <script>
        const audio = document.getElementById('audio');
        audio.volume = 0.1;

        const audioUploadForm = document.getElementById('audio-upload-bar');
        const audioElement = document.getElementById('audio');
        const audioPlaceholder = document.getElementById('audio-placeholder');

        audioUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(audioUploadForm);

            try {
                const response = await fetch(audioUploadForm.action, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    const uploadedAudioPath = result.audioPath;

                    const audioPathInput = document.getElementById('audioPathInput');
                    const originalFileNameInput = document.getElementById('originalFileNameInput');
                    const saveActions = document.getElementById('save-actions');
                    const saveForm = document.getElementById('saveForm');
                    const saveBtn = document.getElementById('saveBtn');
                    const saveVideoBtn = document.getElementById('saveVideoBtn');


                    if (saveActions) saveActions.style.display = 'block';

                    if (saveForm) saveForm.style.display = 'block';

                    if (saveBtn) {
                      saveBtn.disabled = false;
                      saveBtn.textContent = 'Save to Profile';
                    }
                    if (saveVideoBtn) {
                      saveVideoBtn.style.display = 'block';
                      saveVideoBtn.disabled = false;
                      saveVideoBtn.textContent = 'Save Video';
                    }
                    if (audioPathInput) audioPathInput.value = result.audioPath;
                    if (originalFileNameInput) originalFileNameInput.value = result.originalFileName;

                    audioElement.src = uploadedAudioPath;
                    audioElement.style.display = 'block';
                    audioPlaceholder.style.display = 'none';

                    fileInput.value = '';
                    fileLabel.textContent = 'Choose Audio';
                    uploadBtn.disabled = true;
                    uploadBtn.style.opacity = 0.5;
                } else {
                    alert("Upload failed. Try again.");
                }
            } catch (err) {
                console.error(err);
                alert("Upload failed. Try again.");
            }
        });
    </script>

    <script>

        function buildUserSettingsForSave() {
          const ft = document.getElementById("fractalType")?.value || "julia";

          if (ft === "julia") {
            return {
              fractalType: "julia",
              iterations: parseInt(document.getElementById("iterSlider").value, 10),
              bassStrength: parseFloat(document.getElementById("bassSlider").value),
              trebleStrength: parseFloat(document.getElementById("trebleSlider").value),
              primaryColor: document.getElementById("primaryColor").value,
              secondaryColor: document.getElementById("secondaryColor").value,
              rainbow: document.getElementById("rainbowToggle").checked,
              juliaPreset: document.getElementById("juliaPreset")?.value || "classic"
            };
          }

          if (ft === "mandelbrot") {
            return {
              fractalType: "mandelbrot",
              iterations: parseInt(document.getElementById("mandelIterSlider").value, 10),
              bassStrength: parseFloat(document.getElementById("mandelBassSlider").value),
              primaryColor: document.getElementById("mandelPrimaryColor").value,
              secondaryColor: document.getElementById("mandelSecondaryColor").value,
              rainbow: document.getElementById("mandelRainbowToggle").checked
            };
          }

          if (ft === "mandelbulb") {
            return {
                fractalType: "mandelbulb",
                raySteps: parseInt(document.getElementById("bulbRayStepsSlider").value, 10),
                bassStrength: parseFloat(document.getElementById("bulbBassSlider").value),
                trebleStrength: parseFloat(document.getElementById("bulbTrebleSlider").value),
                rotationSpeed: parseFloat(document.getElementById("bulbRotSlider").value),
                zoomPulse: parseFloat(document.getElementById("bulbZoomPulseSlider").value),
                primaryColor: document.getElementById("bulbPrimaryColor").value,
                secondaryColor: document.getElementById("bulbSecondaryColor").value,
                rainbow: document.getElementById("bulbRainbowToggle").checked
            };
          }


          return { fractalType: ft };
        }


        document.getElementById("iterSlider").addEventListener("input", e => {
            updateFractalConfig({
                quality: { iterations: parseInt(e.target.value) }
            });
        });

        document.getElementById("bassSlider").addEventListener("input", e => {
            updateFractalConfig({
                motion: { bassStrength: parseFloat(e.target.value) }
            });
        });

        document.getElementById("trebleSlider").addEventListener("input", e => {
            updateFractalConfig({
                motion: { trebleStrength: parseFloat(e.target.value) }
            });
        });

        document.getElementById("primaryColor").addEventListener("input", e => {
            updateFractalConfig({
                colors: { primary: window.hexToRgb01(e.target.value) }
            });
        });

        document.getElementById("secondaryColor").addEventListener("input", e => {
            updateFractalConfig({
                colors: { secondary: window.hexToRgb01(e.target.value) }
            });
        });

        document.getElementById("rainbowToggle").addEventListener("change", (e) => {
          updateFractalConfig({
            colorMode: { rainbow: e.target.checked }
          });
        });

         document.getElementById("mandelIterSlider").addEventListener("input", e => {
            updateFractalConfig({
                quality: { iterations: parseInt(e.target.value) }
            });
        });

        document.getElementById("mandelBassSlider").addEventListener("input", e => {
            updateFractalConfig({
                motion: { bassStrength: parseFloat(e.target.value) }
            });
        });

        // document.getElementById("mandelTrebleSlider").addEventListener("input", e => {
        //     updateFractalConfig({
        //         motion: { trebleStrength: parseFloat(e.target.value) }
        //     });
        // });

        document.getElementById("mandelPrimaryColor").addEventListener("input", e => {
            updateFractalConfig({
                colors: { primary: window.hexToRgb01(e.target.value) }
            });
        });

        document.getElementById("mandelSecondaryColor").addEventListener("input", e => {
            updateFractalConfig({
                colors: { secondary: window.hexToRgb01(e.target.value) }
            });
        });

        document.getElementById("mandelRainbowToggle").addEventListener("change", e => {
            updateFractalConfig({
                colorMode: { rainbow: e.target.checked }
            });
        });

        document.getElementById("bulbRayStepsSlider")?.addEventListener("input", e => {
          updateFractalConfig({ quality: { raySteps: parseInt(e.target.value, 10) } });
        });

        document.getElementById("bulbBassSlider")?.addEventListener("input", e => {
          updateFractalConfig({ motion: { bassStrength: parseFloat(e.target.value) } });
        });

        document.getElementById("bulbTrebleSlider")?.addEventListener("input", e => {
          updateFractalConfig({ motion: { trebleStrength: parseFloat(e.target.value) } });
        });

        document.getElementById("bulbRotSlider")?.addEventListener("input", e => {
          updateFractalConfig({ motion: { rotationSpeed: parseFloat(e.target.value) } });
        });

        document.getElementById("bulbZoomPulseSlider")?.addEventListener("input", e => {
          updateFractalConfig({ motion: { zoomPulse: parseFloat(e.target.value) } });
        });

        document.getElementById("bulbPrimaryColor")?.addEventListener("input", e => {
          updateFractalConfig({ colors: { primary: window.hexToRgb01(e.target.value) } });
        });

        document.getElementById("bulbSecondaryColor")?.addEventListener("input", e => {
          updateFractalConfig({ colors: { secondary: window.hexToRgb01(e.target.value) } });
        });

        document.getElementById("bulbRainbowToggle")?.addEventListener("change", e => {
          updateFractalConfig({ colorMode: { rainbow: e.target.checked } });
        });

    </script>

    <script>
        const menuToggle = document.getElementById('menuToggle');
        const fractalSettings = document.getElementById('fractal-settings');

        menuToggle.addEventListener('click', () => {
            fractalSettings.classList.toggle('closed');
            menuToggle.classList.toggle('closed');
        });
    </script>

    <script>
        function updateHeaderHeight() {
            const header = document.querySelector('header');
            const headerHeight = header.offsetHeight;
            document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
        }

        window.addEventListener('load', updateHeaderHeight);
        window.addEventListener('resize', updateHeaderHeight);
    </script>

    <script>
        window.addEventListener("DOMContentLoaded", () => {
          const saveForm = document.getElementById('saveForm');
          const saveBtn = document.getElementById('saveBtn');

          if (!saveForm) return;

          saveForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!saveBtn) return;

            const settingsJsonInput = document.getElementById("settingsJsonInput");
            const fractalTypeInput = document.getElementById("fractalTypeInput");

            const ft = document.getElementById("fractalType")?.value || "julia";
            fractalTypeInput.value = ft;

            const userSettings = buildUserSettingsForSave();

            if (!userSettings || Object.keys(userSettings).length === 0) {
              console.error("buildUserSettingsForSave returned empty:", userSettings);
              alert("Could not capture settings to save.");
              return;
            }

            settingsJsonInput.value = JSON.stringify(userSettings);

            // console.log("Saving project:", {
            //   fractalType: fractalTypeInput.value,
            //   settingsJsonLen: settingsJsonInput.value?.length
            // });

            const formData = new FormData(saveForm);

            const oldText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
              const response = await fetch(saveForm.action, {
                method: 'POST',
                body: formData
              });

              const result = await response.json();

              if (result.success) {
                saveBtn.textContent = '✓ Saved to Profile';
                saveBtn.disabled = true;
              } else {
                saveBtn.textContent = oldText;
                saveBtn.disabled = false;
                alert(result.message || 'Save failed.');
              }
            } catch (err) {
              console.error(err);
              saveBtn.textContent = oldText;
              saveBtn.disabled = false;
              alert('Save failed.');
            }
          });
        });
    </script>


    <script>
        const saveVideoBtn = document.getElementById('saveVideoBtn');
        const audioEl = document.getElementById('audio');

        function getFractalCanvas() {
          const container = document.getElementById('fractal-container');
          return container ? container.querySelector('canvas') : null;
        }

        function downloadBlob(blob, filename) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

        async function ensureAudioGraph(audioEl) {
          if (!window.__studioAudio) window.__studioAudio = {};
          const shared = window.__studioAudio;

          if (!shared.ctx) {
            shared.ctx = new (window.AudioContext || window.webkitAudioContext)();
          }

          if (shared.ctx.state === "suspended") {
            await shared.ctx.resume();
          }

          if (!shared.source) {
            shared.source = shared.ctx.createMediaElementSource(audioEl);

            shared.source.connect(shared.ctx.destination);
          }

          return shared;
        }


        async function recordFractalWithAudioToBlob() {
          const audioEl = document.getElementById("audio");
          if (!audioEl || !audioEl.src) throw new Error("No audio loaded.");

          window.__isRecordingVideo = true;

          try {
            const shared = await ensureAudioGraph(audioEl);

            if (audioEl.paused) await audioEl.play();

            await new Promise(requestAnimationFrame);

            const canvas = getFractalCanvas();
            if (!canvas) throw new Error("Fractal canvas not found.");

            const canvasStream = canvas.captureStream(60);

            const dest = shared.ctx.createMediaStreamDestination();
            shared.source.connect(dest);

            const mixedStream = new MediaStream([
              ...canvasStream.getVideoTracks(),
              ...dest.stream.getAudioTracks()
            ]);

            let mimeType = "video/webm;codecs=vp9,opus";
            if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = "video/webm;codecs=vp8,opus";
            if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = "video/webm";

            const recorder = new MediaRecorder(mixedStream, {
              mimeType,
              videoBitsPerSecond: 45_000_000, // 45 Mbps
              audioBitsPerSecond: 320_000     // 320 kbps
            });
            const chunks = [];

            recorder.ondataavailable = (e) => {
              if (e.data && e.data.size > 0) chunks.push(e.data);
            };

            const stopped = new Promise((resolve) => (recorder.onstop = resolve));

            await new Promise(requestAnimationFrame);

            recorder.start();

            await new Promise((resolve) => {
              const handler = () => {
                audioEl.removeEventListener("ended", handler);
                resolve();
              };
              audioEl.addEventListener("ended", handler);
            });

            recorder.stop();
            await stopped;

            try { shared.source.disconnect(dest); } catch (_) {}

            return new Blob(chunks, { type: mimeType });
          } finally {
            window.__isRecordingVideo = false;
          }
        }



        if (saveVideoBtn) {
          saveVideoBtn.addEventListener('click', async () => {
            try {
              saveVideoBtn.disabled = true;
              const oldText = saveVideoBtn.textContent;
              saveVideoBtn.textContent = 'Recording...';

              const blob = await recordFractalWithAudioToBlob();

              saveVideoBtn.textContent = 'Downloading...';
              downloadBlob(blob, 'fractal-video.webm');

              saveVideoBtn.textContent = 'Save Video';
              saveVideoBtn.disabled = false;
            } catch (err) {
              console.error(err);
              alert(err.message || 'Save video failed.');
              saveVideoBtn.textContent = 'Save Video';
              saveVideoBtn.disabled = false;
            }
          });
        }
    </script>

    <script>
        window.__initialProject = {
          fractalType: "@(Model.ProjectFractalType ?? "")",
          settingsJson: @Html.Raw(string.IsNullOrEmpty(Model.ProjectSettingsJson) ? "null" : Model.ProjectSettingsJson)
        };
    </script>


}